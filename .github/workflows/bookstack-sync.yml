name: BookStack KCS Integration

on:
  issues:
    types: [opened, edited, closed]

jobs:
  bookstack-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Sync Issue to BookStack via curl
        env:
          BOOKSTACK_API_URL: ${{ secrets.BOOKSTACK_API_URL }}
          BOOKSTACK_API_TOKEN_ID: ${{ secrets.BOOKSTACK_API_TOKEN_ID }}
          BOOKSTACK_API_TOKEN_SECRET: ${{ secrets.BOOKSTACK_API_TOKEN_SECRET }}
        run: |
          TITLE="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"

          # Простейший slug: нижний регистр + дефисы
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')

          curl --fail -X POST \
            "$BOOKSTACK_API_URL/api/pages" \
            -H "Authorization: Token $BOOKSTACK_API_TOKEN_ID:$BOOKSTACK_API_TOKEN_SECRET" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "name": "$TITLE",
            "html": "$BODY",
            "book_id": 1,
            "slug": "$SLUG"
          }
          EOF
